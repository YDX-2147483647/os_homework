# å®éªŒ2 è¯»è€…å†™è€…é—®é¢˜

## å®éªŒå†…å®¹

åœ¨Windowsç¯å¢ƒä¸‹ï¼Œåˆ›å»ºä¸€ä¸ªæ§åˆ¶å°è¿›ç¨‹ï¼Œæ­¤è¿›ç¨‹åŒ…å«nä¸ªçº¿ç¨‹ã€‚ç”¨è¿™nä¸ªçº¿ç¨‹æ¥è¡¨ç¤ºnä¸ªè¯»è€…æˆ–å†™è€…ã€‚æ¯ä¸ªçº¿ç¨‹æŒ‰è¾“å…¥çš„è¦æ±‚è¿›è¡Œè¯»å†™æ“ä½œã€‚ç”¨ä¿¡å·é‡æœºåˆ¶åˆ†åˆ«å®ç°è¯»è€…ä¼˜å…ˆå’Œå†™è€…ä¼˜å…ˆé—®é¢˜ã€‚

è¿è¡Œç»“æœæ˜¾ç¤ºè¦æ±‚ï¼šè¦æ±‚åœ¨æ¯ä¸ªçº¿ç¨‹åˆ›å»ºã€å‘å‡ºè¯»å†™ç”³è¯·ã€å¼€å§‹è¯»å†™æ“ä½œå’Œç»“æŸè¯»å†™æ“ä½œæ—¶åˆ†åˆ«æ˜¾ç¤ºä¸€è¡Œæç¤ºä¿¡æ¯ï¼Œä»¥ç¡®å®šæ‰€æœ‰å¤„ç†éƒ½éµå®ˆç›¸åº”çš„è¯»å†™æ“ä½œé™åˆ¶ã€‚

## å®éªŒç›®çš„

1. é€šè¿‡ç¼–å†™å’Œè°ƒè¯•ç¨‹åºä»¥åŠ æ·±å¯¹è¿›ç¨‹ã€çº¿ç¨‹ç®¡ç†æ–¹æ¡ˆçš„ç†è§£ã€‚
2. ç†Ÿæ‚‰Windowså¤šçº¿ç¨‹ç¨‹åºè®¾è®¡æ–¹æ³•ã€‚

## å®éªŒåŸºç¡€çŸ¥è¯†

> ä»¥ä¸‹å¾ˆå¤šåœ°æ–¹çš„â€œçº¿ç¨‹â€æ¢æˆâ€œè¿›ç¨‹â€åŒæ ·é€‚ç”¨ï¼Œç”šè‡³æ›´åˆç†ã€‚ä¸è¿‡è¿™æ¬¡å®éªŒæ˜¯å¤šçº¿ç¨‹ï¼Œæ‰€ä»¥éƒ½å†™çš„æ˜¯â€œçº¿ç¨‹â€ã€‚

### åŒæ­¥é—®é¢˜

å¤šä¸ªçº¿ç¨‹å¯èƒ½å¸Œæœ›åä½œä½¿ç”¨åŒä¸€èµ„æºï¼Œéœ€è¦å°½å¯èƒ½å®ç°äº’æ–¥ä½¿ç”¨ã€æœ‰ç©ºè®©è¿›ã€ä¼˜å…ˆç­‰å¾…ã€‚

### ä¿¡å·é‡

ä¿¡å·é‡ï¼ˆsemaphoreï¼‰ç”¨äºè§£å†³åŒæ­¥é—®é¢˜ï¼Œä»£è¡¨å¯ç”¨çš„èµ„æºã€‚

å…·ä½“æ¥è¯´ï¼Œä¿¡å·é‡åŒ…æ‹¬ä¸€ä¸ªæ•´æ•°ï¼Œæ¶‰åŠå¦‚ä¸‹ä¸¤ç§åŸå­æ“ä½œã€‚

```rust
/// ç­‰å¾…ç©ºé—²èµ„æºå¹¶è·å–
fn wait(semaphore) {
    semaphore.value -= 1;
    if semaphore.value < 0 {
        // è‹¥æ— å¯ç”¨èµ„æºï¼Œç­‰å¾…åˆ«äººç”¨å®Œé€šçŸ¥
        semaphore.list.push(this_process);
        sleep();
    }
}

/// é‡Šæ”¾èµ„æºå¹¶é€šçŸ¥ä»–äººå¯ä»¥åˆ©ç”¨
fn signal(semaphore) {
    semaphore += 1;
    if semaphore.value <= 0 {
        let process = semaphore.list.pop();
        wake_up(process);
    }
}
```

åœ¨å¤šä¸ªçº¿ç¨‹å„è‡ª`wait`ã€`signal`åŒä¸€å…¬ç”¨ä¿¡å·é‡ï¼Œå¯ä»¥è§£å†³åŒæ­¥é—®é¢˜ã€‚åœ¨æ¯ä¸€çº¿ç¨‹å…ˆå`wait`ã€`signal`åŒä¸€ç§ç”¨ä¿¡å·é‡ï¼Œå¯ä»¥è§£å†³äº’æ–¥é—®é¢˜ã€‚

### è¯»è€…â€”å†™è€…é—®é¢˜

è¯»è€…â€”å†™è€…é—®é¢˜è¯»å†™æ“ä½œçš„é€šç”¨é™åˆ¶ï¼š

- å†™â€”å†™äº’æ–¥ï¼šä¸èƒ½æœ‰ä¸¤ä¸ªå†™è€…åŒæ—¶è¿›è¡Œå†™æ“ä½œã€‚

- è¯»â€”å†™äº’æ–¥ï¼šä¸èƒ½åŒæ—¶æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¯»ï¼Œè€Œå¦ä¸€ä¸ªçº¿ç¨‹åœ¨å†™ã€‚

- è¯»â€”è¯»å…è®¸ï¼šå¯ä»¥æœ‰ä¸€ä¸ªæˆ–å¤šä¸ªè¯»è€…åœ¨è¯»ã€‚

é™„åŠ é™åˆ¶ï¼š

- **è¯»è€…ä¼˜å…ˆ**ï¼šè¯»è€…ç”³è¯·æ—¶ï¼Œåªè¦å·²æœ‰å…¶å®ƒè¯»è€…æ­£åœ¨è¯»ï¼Œåˆ™å®ƒå¯ç›´æ¥å¼€å§‹æ“ä½œï¼Œä¸ç†ä¼šå†™è€…çš„è¯·æ±‚ã€‚
- **å†™è€…ä¼˜å…ˆ**ï¼šä¸€æ—¦æœ‰å†™è€…ç”³è¯·ï¼Œä»»ä½•æ–°è¯»è€…éƒ½å¿…é¡»å…ˆç­‰å¾…ã€‚
- **å…¬å¹³ç«äº‰**ï¼šæ‰€æœ‰æ“ä½œè€…éƒ½è¦åœ¨`service`çš„ç­‰å¾…é˜Ÿåˆ—ä¸­æ’é˜Ÿï¼Œä»è€Œä¿è¯å…¬å¹³ã€‚

## å®éªŒè®¾è®¡æ–¹æ³•

> å¦è¯·å‚é˜…è‡ªåŠ¨ç”Ÿæˆçš„æ–‡æ¡£ï¼š`cargo doc --open`æˆ–æ‰‹åŠ¨æ‰“å¼€`target/doc/ex_2/index.html`ã€‚é‚£é‡Œä¼šæœ‰æ›´ç»†èŠ‚çš„ä¸œè¥¿ï¼Œæ¯”å¦‚`id`å­˜å‚¨æ—¶æ˜¯ç”¨å¤šå°‘ä½æ•´æ•°ã€‚

### æ“ä½œå‘˜`Operator`ï¼ˆ`operator.rs`ï¼‰

#### ç»“æ„

é’ˆå¯¹è¾“å…¥è®¾è®¡`Operator`æ“ä½œå‘˜ã€‚ï¼ˆå¦‚ä¸‹

```mermaid
classDiagram-v2
class Operator {
    +id: u32 åºå·
    +role: OperatorRole è§’è‰²
    +start_at: f32 æ“ä½œå¼€å§‹æ—¶åˆ»ï¼Œå•ä½ä¸ºç§’ï¼Œæ­£æ•°
    +duration: f32 æ“ä½œæŒç»­æ—¶é—´ï¼Œæ­£æ•°
}
```

å…¶ä¸­è§’è‰²`role: OperatorRole`å¦‚ä¸‹ã€‚

```rust
#[derive(Debug, PartialEq)]
pub enum OperatorRole {
    Reader,
    Writer,
}
```

#### åŠŸèƒ½

- `Operator::from(line: &str) -> Result<Operator, OperatorParseError>`

  å°†å­—ç¬¦ä¸²ï¼ˆå¦‚`"1 R 3.3 5"`ï¼‰è§£æä¸º`Operator`ã€‚

  > è§£æå­—ç¬¦ä¸²è¦å¹²å¾ˆå¤šçç¢çš„äº‹ï¼ŒæŠ›å‡ºå„ç§é”™è¯¯ï¼ˆ`enum OperatorParseError`ï¼‰ã€‚ç„¶è€Œæ²¡å¤ªå¤§å…³ç³»ï¼Œå°±ä¸å¤šä»‹ç»äº†ã€‚

- `ready_inputs() -> Vec<Operator>`

  ä» stdin è¯»å–è‹¥å¹²è¡Œï¼Œè§£æä¸º`Operator`åˆ—è¡¨ã€‚

### åŒæ­¥æ–¹æ¡ˆ`run_â—‹â—‹(â€¦)`ï¼ˆ`solutions.rs`ï¼‰

æ¯ç§åŒæ­¥æ–¹æ¡ˆå†™æˆä¸€ä¸ªå‡½æ•°ã€‚

- **è¾“å…¥**ï¼šæ“ä½œå‘˜åˆ—è¡¨ï¼ˆ`operators: Vec<Operator>`ï¼‰ã€‚

- **åŠŸèƒ½**ï¼š

  1. å»ºç«‹åŒæ­¥æ‰‹æ®µï¼ˆä¿¡å·é‡ç­‰ï¼‰ã€‚

  2. è®©æ¯ä½æ“ä½œå‘˜åœ¨ä¸€ä¸ªçº¿ç¨‹è¿è¡Œã€‚

     ï¼ˆè¿è¡Œæ—¶å¹¶ä¸çœŸçš„è¯»å†™æ–‡ä»¶ï¼Œåªæ˜¯ç”¨`thread::sleep`æ¨¡æ‹Ÿï¼‰

  3. ç­‰å¾…æ‰€æœ‰æ“ä½œå‘˜ç»“æŸã€‚

- **æ²¡æœ‰çš„åŠŸèƒ½**ï¼šæ‰“å°è¿è¡Œè®°å½•ã€‚

  `run_â—‹â—‹()`ä¼šå‘å¤–å‘é€æ¶ˆæ¯ï¼ˆ`tx.send((â€¦))`ï¼‰æ¥ä¼ é€’è¿è¡Œè®°å½•ï¼ŒæŠŠè¿™äº›è®°å½•æ‰“å°å‡ºæ¥æ˜¯`Reporter`çš„å·¥ä½œã€‚

  > å®é™…ä¸Š`run_â—‹â—‹()`è¿˜éœ€è¦å¦ä¸€å‚æ•°æ¥å…¥ç®¡é“â€”â€”`tx: Sender<ReportMessage>`ã€‚è¿™äº›ä¸œè¥¿ä¼šåœ¨`Reporter`ä¸€èŠ‚ä»‹ç»ã€‚

#### è¯»è€…ä¼˜å…ˆæ–¹æ¡ˆ`run_read_preferring`

è¯»è€…ç”³è¯·æ—¶ï¼Œåªè¦å·²æœ‰å…¶å®ƒè¯»è€…æ­£åœ¨è¯»ï¼Œåˆ™å®ƒå¯ç›´æ¥å¼€å§‹æ“ä½œï¼Œä¸ç†ä¼šå†™è€…çš„è¯·æ±‚ã€‚

##### åŸç†

1. ç”±äºäº’æ–¥è®¿é—®ï¼ˆè¯»è€…å›¢ä½“â€”å†™è€…ã€å†™è€…â€”å¦ä¸€å†™è€…ï¼‰ï¼Œéœ€ç”¨**ä¿¡å·é‡`access`**è¡¨ç¤ºæ–‡ä»¶çš„è¯»å†™æƒã€‚

   è°å æœ‰`access`ï¼ˆæŠŠ`acess`æ”¹æˆå‡ï¼‰ï¼Œè°å°±èƒ½æ“ä½œæ–‡ä»¶ã€‚

   åˆå§‹æ—¶ï¼Œæ‰€æœ‰äººéƒ½å¯éšæ—¶å¤ºæƒï¼Œå› æ­¤å–çœŸã€‚

   ```rust
   let access = Arc::new((Mutex::new(true), Condvar::new()));
   ```

   > å…³äºä¿¡å·é‡ä¸ºä»€ä¹ˆå†™æˆè¿™æ ·ï¼Œä¼šåœ¨`Semaphore`ä¸€èŠ‚ä»‹ç»ã€‚

2. è¯»è€…ä½œä¸ºä¸€ä¸ªå›¢ä½“å’Œå…¶ä»–äººäº’æ–¥ï¼Œå›¢ä½“å†…éƒ¨å¯å…è®¸åŒæ—¶è®¿é—®ã€‚å› æ­¤ï¼Œå›¢ä½“ä¸­ç¬¬ä¸€äººå¤ºæƒï¼Œæœ€åä¸€äººæ”¾æƒã€‚

   ç”±äºâ€œç¬¬ä¸€äººâ€å’Œâ€œæœ€åä¸€äººâ€å¾€å¾€ä¸æ˜¯åŒä¸€äººï¼Œå¿…é¡»æ“ä½œå‘˜é—´é€šä¿¡æ‰èƒ½å®ç°ï¼Œæ•…è®¾ç½®**è®¡æ•°å™¨`n_readers`**è®°å½•å½“å‰**æ­£åœ¨è®¿é—®çš„è¯»è€…**æ•°é‡ã€‚

   åˆå§‹æ—¶ï¼Œæ— è¯»è€…åœ¨è®¿é—®ï¼Œå–é›¶ã€‚

   ```rust
   let mut n_readers = 0; // éƒ¨åˆ†æ­£ç¡®
   ```

3. è¯»è€…æ•´ä¸ªå›¢ä½“è¦å…±åŒç»´æŠ¤`n_readers`ä¸€ä¸ªå˜é‡ï¼Œå¿…é¡»äº’æ–¥è®¿é—®ã€‚

   è¿™é‡Œä½¿ç”¨**äº’æ–¥é”`Mutex`**å®ç°ã€‚ä¸Šä¸€è¡Œä¿®æ”¹å¦‚ä¸‹ã€‚

   ```rust
   let n_readers = Arc::new(Mutex::new(0));
   ```

4. ç°åœ¨**æ£€æŸ¥**ä¸€ä¸‹è¯»è€…æ˜¯å¦çœŸçš„ä¼˜å…ˆã€‚

   è¯»è€…ç”³è¯·æ—¶ï¼Œåªè¦å·²æœ‰å…¶å®ƒè¯»è€…æ­£åœ¨è¯»ï¼Œå°±è¯´æ˜è¯»è€…å›¢ä½“å·²ç»æŠŠ`access`å¤ºäº†ï¼Œåˆ™å®ƒå¯ç›´æ¥å¼€å§‹æ“ä½œï¼Œä¸ç†ä¼šå†™è€…çš„è¯·æ±‚ã€‚

   è€Œå†™è€…ç”³è¯·æ—¶ï¼Œå¤ºåˆ°`access`å‰å¿…é¡»ç­‰æ•´ä¸ªè¯»è€…å›¢ä½“æ”¾æƒï¼Œå³æ‰€æœ‰è¯»è€…éƒ½è¯»å®Œäº†ã€‚

##### å®ç°

- **æ€»ä½“**

  ```mermaid
  flowchart TB
  subgraph åˆå§‹åŒ–
      direction TB
      init_access["access = Semaphore(true)"]
      init_n["n_readers = Mutex(0)"]
      %% init_now["now = Instant::now()"]
  end
  
  åˆå§‹åŒ– --> for
  
  subgraph for["for o in operators"]
      match[o.role]
      -->|Reader| spawn_r[æ–°å»ºè¯»è€…çº¿ç¨‹]
      match -->|Writer| spawn_w[æ–°å»ºå†™è€…çº¿ç¨‹]
  end
  ```

  > å› ä¸ºæ“ä½œå‘˜ä¼šå‘ä¸»çº¿ç¨‹çš„`Reporter`å‘é€è¿è¡Œè®°å½•ï¼Œä¸»çº¿ç¨‹å¤©ç„¶ä¼šç­‰å¾…è¿™äº›çº¿ç¨‹ï¼Œæ— éœ€`join`ã€‚

  å¤§æ¶å­éƒ½æ˜¯è¿™ä¸€å¥—ï¼Œåé¢å°±ä¸é‡å¤äº†ã€‚

- **å†™è€…**

  ```mermaid
  flowchart LR
  create --> sleep["sleep(o.start_at)"]
  --> wait["wait(access)"]:::sema
  --> write:::crit
  --> signal["signal(access)"]:::sema
  
  subgraph access
      write
      signal
  end
  
  classDef crit fill: red;
  classDef sema fill: orange;
  ```

  > è¿™ä¸€èŠ‚ä¼šå±•ç¤ºæµç¨‹å›¾æ€ä¹ˆå¯¹åº”åˆ°ä»£ç ï¼Œä¹‹åå°±ä¸å±•ç¤ºäº†ã€‚

  ```rust
  thread::spawn(move || {
      tx.send((o.id, Action::Create, now.elapsed())).unwrap();
      // â†‘ å‘å¤–å‘é€è¿è¡Œè®°å½•ï¼ŒååŒã€‚
  
      thread::sleep(Duration::from_secs_f32(o.start_at));
  
      tx.send((o.id, Action::RequestWrite, now.elapsed()))
          .unwrap();
      wait(&*access);
  
      tx.send((o.id, Action::StartWrite, now.elapsed())).unwrap();
      thread::sleep(Duration::from_secs_f32(o.duration));
      tx.send((o.id, Action::EndWrite, now.elapsed())).unwrap();
  
      signal(&*access);
  })
  ```

- **è¯»è€…**

  ```mermaid
  flowchart TB
  create --> sleep["sleep(o.start_at)"]
  --> enter
  --> write:::crit
  --> exit
  
  subgraph enter["n_readersçš„äº’æ–¥é”"]
      increase["*n_readers += 1"]
      --> if_first{*n_readers == 1}
      -->|æ˜¯| wait["wait(access)"]:::sema
  end
  
  subgraph exit["n_readersçš„äº’æ–¥é”"]
      decrease["*n_readers -= 1"]
      --> if_last{*n_readers == 0}
      -->|æ˜¯| signal["signal(access)"]:::sema
  end
  
  classDef crit fill: red;
  classDef sema fill: orange;
  ```

  ```rust
  thread::spawn(move || {
      tx.send((o.id, Action::Create, now.elapsed())).unwrap();
  
      thread::sleep(Duration::from_secs_f32(o.start_at));
  
      tx.send((o.id, Action::RequestRead, now.elapsed())).unwrap();
      {
          let mut n_readers = n_readers.lock().unwrap();
          *n_readers += 1;
  
          // if I am the first
          if *n_readers == 1 {
              wait(&*access);
          }
      }
  
      tx.send((o.id, Action::StartRead, now.elapsed())).unwrap();
      thread::sleep(Duration::from_secs_f32(o.duration));
      tx.send((o.id, Action::EndRead, now.elapsed())).unwrap();
  
      {
          let mut n_readers = n_readers.lock().unwrap();
          *n_readers -= 1;
  
          // if I am the last
          if *n_readers == 0 {
              signal(&*access);
          }
      }
  })
  ```

#### å†™è€…ä¼˜å…ˆæ–¹æ¡ˆ`run_write_preferring`

ä¸€æ—¦æœ‰å†™è€…ç”³è¯·ï¼Œä»»ä½•æ–°è¯»è€…éƒ½å¿…é¡»å…ˆç­‰å¾…ã€‚

##### åŸç†

1. åŒå‰ï¼Œè®¾è®¡ä¿¡å·é‡`access`ã€è®¡æ•°å™¨`n_readers`ã€`n_readers`çš„äº’æ–¥é”ã€‚

2. æ–°è¯»è€…æœ‰æ—¶è¦å› å†™è€…è€Œç­‰å¾…ï¼Œè¿™æ¶‰åŠé€šä¿¡ï¼Œè‚¯å®šè¦å¦è®¾è®¡**ä¿¡å·é‡`can_reader_acquire`**ã€‚

   > åœ¨æˆ‘çš„ç¨‹åºä¸­ï¼Œrequest å¯¹åº”æ•´ä¸ªç”³è¯·æƒé™çš„è¿‡ç¨‹ï¼Œacquire è¡¨ç¤ºç”³è¯·`access`ã€‚å¦‚æœå¯¹å¤–å°è£…ï¼Œé‚£ä¹ˆçœ‹å¾—åˆ° requestï¼Œçœ‹ä¸åˆ° acquireã€‚

   åˆå§‹æ—¶ï¼Œæ— å†™è€…ï¼Œè¯»è€…æ€»å¯ç”³è¯·ï¼Œå› æ­¤å–çœŸã€‚

   ```rust
   let can_reader_acquire = Arc::new((Mutex::new(true), Condvar::new()));
   ```

3. å­˜åœ¨å†™è€…ç­‰å¾…æ—¶ï¼Œæ–°è¯»è€…è¦å»¶åç”³è¯·`access`ï¼Œå¦åˆ™æ— éœ€ã€‚â€œå­˜åœ¨ç­‰å¾…å†™è€…ä¸å¦â€è¯´æ˜éœ€è®¾ç½®**è®¡æ•°å™¨`n_writers`**è®°å½•å½“å‰**æ­£åœ¨ç­‰å¾…æˆ–è®¿é—®çš„å†™è€…**æ•°é‡ã€‚

   æ³¨æ„`n_writers`ä¹Ÿç®—é‚£äº›æ­£åœ¨ç­‰`access`çš„å†™è€…ï¼Œè€Œ`n_readers`ä¸è®¡ã€‚äº‹å®ä¸Šç”±äºè¯»è€…å›¢ä½“å†…éƒ¨ä¸äº’æ–¥ï¼Œä»–ä»¬æ ¹æœ¬ä¸å­˜åœ¨â€œç­‰`access`â€è¿™ä¸€çŠ¶æ€ã€‚

   åˆå§‹æ—¶æ— å†™è€…ï¼Œä¸ºé›¶ã€‚

4. åŒç†ï¼Œ`n_writers`ä¹Ÿéœ€è¦**äº’æ–¥é”**ã€‚

   ```rust
   let n_writers = Arc::new(Mutex::new(0));
   ```

5. æ€æ ·å°†â€œå­˜åœ¨ç­‰å¾…å†™è€…ä¸å¦â€è½¬æ¢ä¸º`can_reader_acquire`ï¼Ÿæœ‰å†™è€…ç­‰å¾…æˆ–è®¿é—®æ—¶ï¼ŒæŠŠ`can_reader_acquire`æŠ¢èµ°ï¼ˆå‰¯ä½œç”¨ï¼šæ”¹ä¸º`false`ï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œç¬¬ä¸€ä½å†™è€…æ¥æ—¶`wait`ï¼ˆé˜»å¡æ‰€æœ‰æ–°è¯»è€…ï¼‰ï¼Œæœ€åä¸€ä½èµ°æ—¶`signal`ï¼ˆé€šçŸ¥æ–°è¯»è€…å¯ä»¥ç”³è¯·`access`ï¼‰ã€‚

##### å®ç°

- **æ€»ä½“**

  ```mermaid
  flowchart LR
  subgraph åˆå§‹åŒ–
      direction LR
      init_access["access = Semaphore(true)"]
      init_n["n_readers = Mutex(0)"]
      n_w["n_writers = Mutex(0)"]
      can["can_reader_acquire = Semaphore(true)"]
  end
  
  åˆå§‹åŒ– --> ell["â€¦"]
  ```

- **å†™è€…**

  ```mermaid
  flowchart TB
  create --> sleep["sleep(o.start_at)"]
  --> enter
  --> wait["wait(access)"]:::sema
  --> write:::crit
  --> signal["signal(access)"]:::sema
  --> exit
  
  subgraph access
      write
      signal
  end
  
  subgraph enter["n_writersçš„äº’æ–¥é”"]
      increase["*n_writers += 1"]
      --> if_first{*n_writers == 1}
      -->|æ˜¯| wait_can["wait(can_reader_acquire)"]:::sema
  end
  
  subgraph exit["n_writersçš„äº’æ–¥é”"]
      decrease["*n_writers -= 1"]
      --> if_last{*n_writers == 0}
      -->|æ˜¯| signal_can["signal(can_reader_acquire)"]:::sema
  end
  
  classDef crit fill: red;
  classDef sema fill: orange;
  ```

- **è¯»è€…**

  ```mermaid
  flowchart TB
  create --> sleep["sleep(o.start_at)"]
  --> wait_can["wait(can_reader_acquire)"]:::sema
  --> enter
  --> signal_can["signal(can_reader_acquire)"]:::sema
  --> write:::crit
  --> exit
  
  subgraph enter["n_readersçš„äº’æ–¥é”"]
      increase["*n_readers += 1"]
      --> if_first{*n_readers == 1}
      -->|æ˜¯| wait["wait(access)"]:::sema
  end
  
  subgraph can_reader_acquire
      enter
      signal_can
  end
  
  subgraph exit["n_readersçš„äº’æ–¥é”"]
      decrease["*n_readers -= 1"]
      --> if_last{*n_readers == 0}
      -->|æ˜¯| signal["signal(access)"]:::sema
  end
  
  classDef crit fill: red;
  classDef sema fill: orange;
  ```

##### ä¸€ä¸ªé”™è¯¯å®ç°åŠè§£å†³

æˆ‘ä¸€ä¸å°å¿ƒå°±æ­»é”äº†â€¦â€¦å½“æ—¶ä¸€ä¸ªå†™è€…ï¼ˆ#2ï¼‰ç»“æŸåï¼Œæ— æ³•é€šçŸ¥ä¸‹ä¸€å†™è€…ï¼ˆ#5ï¼‰å¼€å§‹å†™å…¥ã€‚

```powershell
> cat .\test_cases\mixed.in | cargo run -- write-preferring --tab 10
 0.000 s |          #1ï¼šğŸš€åˆ›å»ºã€‚
 0.000 s |                    #2ï¼šğŸš€åˆ›å»ºã€‚
 0.000 s |                              #3ï¼šğŸš€åˆ›å»ºã€‚
 0.000 s |                                        #4ï¼šğŸš€åˆ›å»ºã€‚
 0.000 s |                                                  #5ï¼šğŸš€åˆ›å»ºã€‚
 3.004 s |          #1ï¼šğŸ””ğŸ‘€ç”³è¯·è¯»å–ã€‚
 3.005 s |          #1ï¼šğŸğŸ‘€å¼€å§‹è¯»å–ã€‚
 4.021 s |                    #2ï¼šğŸ””ğŸ“ç”³è¯·å†™å…¥ã€‚
 5.010 s |                              #3ï¼šğŸ””ğŸ‘€ç”³è¯·è¯»å–ã€‚
 5.110 s |                                                  #5ï¼šğŸ””ğŸ“ç”³è¯·å†™å…¥ã€‚
 6.020 s |                                        #4ï¼šğŸ””ğŸ‘€ç”³è¯·è¯»å–ã€‚
 8.024 s |          #1ï¼šğŸ›‘ğŸ‘€ç»“æŸè¯»å–ã€‚
 8.025 s |                    #2ï¼šğŸğŸ“å¼€å§‹å†™å…¥ã€‚
13.030 s |                    #2ï¼šğŸ›‘ğŸ“ç»“æŸå†™å…¥ã€‚
# è¿è¡Œåˆ°è¿™é‡Œåº”è¯¥è®© #5 å¼€å§‹å†™å…¥ï¼Œä½†å®é™…ä¼šå¡ä½ã€‚
```

å½“æ—¶çš„å†™è€…çº¿ç¨‹å¦‚ä¸‹ã€‚

```mermaid
flowchart TB
ell["â€¦"]
--> enter
--> write:::crit
--> exit

subgraph access
    write
    exit
end

subgraph enter["n_writersçš„äº’æ–¥é”"]
    increase["*n_writers += 1"]
    --> if_first{*n_writers == 1}
    -->|æ˜¯| wait_can["wait(can_reader_acquire)"]:::sema
    --> wait["wait(access)"]:::sema
    if_first -->|å¦| wait
end

subgraph exit["n_writersçš„äº’æ–¥é”"]
    decrease["*n_writers -= 1"]
    --> if_last{*n_writers == 0}
    -->|æ˜¯| signal_can["signal(can_reader_acquire)"]:::sema
    --> signal["signal(access)"]:::sema
    if_last -->|å¦| signal
end

classDef crit fill: red;
classDef sema fill: orange;
```

ç°åœ¨çš„å†™è€…å‡†å¤‡é€€å‡ºæ—¶ï¼Œä¸‹ä¸€ä¸ªå†™è€…ï¼ˆ#5ï¼‰å·²ç»æ‹¿ç€ï¼ˆç¬¬ä¸€æ®µï¼‰`n_writers`çš„é”åœ¨`wait(access)`ï¼Œå¯ç°åœ¨çš„å†™è€…ï¼ˆ#2ï¼‰ä¸æ‹¿åˆ°ï¼ˆç¬¬äºŒæ®µï¼‰`n_writers`çš„é”å°±æ— æ³•`signal(access)`ã€‚äºæ˜¯å¡ä½äº†ã€‚

```mermaid
flowchart LR

2([ç°åœ¨çš„å†™è€…<br>#2]) -.-> n_writersçš„é”:::sema --> 5([ä¸‹ä¸€ä¸ªå†™è€…<br>#5])
-.-> access:::sema --> 2

classDef sema fill: orange;
```

è§£å†³åŠæ³•ï¼š

- å°†`wait(access)`å‘åæŒªå‡º`n_writers`çš„é”ã€‚
- å°†`signal(access)`å‘å‰æŒªå‡º`n_writers`çš„é”ã€‚

æ‰§è¡Œä»»æ„ä¸€ç§åŠæ³•å³å¯æ‰“ç ´æ­»é”ï¼Œæœ€åæˆ‘ä¸¤ç§éƒ½é‡‡å–äº†ã€‚

> æˆ‘å½“æ—¶å…ˆè¯•éªŒå‡ºè§£å†³åŠæ³•ï¼ˆå°½é‡è®©`wait`ã€`signal`é¡ºåºç›¸åï¼‰ï¼Œç„¶åæ‰ååº”è¿‡æ¥æ€ä¹ˆå›äº‹â€¦â€¦

#### å…¬å¹³ç«äº‰`run_unspecified_priority`

æ‰€æœ‰æ“ä½œå‘˜éƒ½è¦ä¸€èµ·æ’é˜Ÿï¼Œä»è€Œä¿è¯å…¬å¹³ã€‚

##### åŸç†

1. åŒå‰ï¼Œè®¾è®¡ä¿¡å·é‡`access`ã€è®¡æ•°å™¨`n_readers`ã€`n_readers`çš„äº’æ–¥é”ã€‚

2. æ‰€æœ‰æ“ä½œå‘˜æ’çš„é˜Ÿæ˜¯ä¸€ä¸ªä¿¡å·é‡çš„ç­‰å¾…é˜Ÿåˆ—ï¼Œè¿™ä¸ª**ä¿¡å·é‡**ç§°ä½œ**`service`**ã€‚

   åˆå§‹æ—¶ï¼Œé˜Ÿæ˜¯ç©ºçš„ï¼Œå–çœŸå³å¯ã€‚

   ```rust
   let service = Arc::new((Mutex::new(true), Condvar::new()));
   ```

   æ‰€æœ‰æ“ä½œå‘˜ç”³è¯·`access`æ—¶éƒ½è¦åœ¨`service`æ’é˜Ÿï¼Œç”³è¯·å‰`wait`ï¼Œç”³è¯·å`signal`ã€‚

3. **æ£€æŸ¥**ä¸€ä¸‹æœ‰æ²¡æœ‰ç ´åè¯»è€…å›¢ä½“å†…å…è®¸ã€‚

   è¯»è€…çš„`service`åŒºé—´å‡ ä¹å’Œ`n_readers`çš„äº’æ–¥é”ä¸€è‡´ï¼Œæ‰€ä»¥æ²¡ç ´åã€‚

##### å®ç°

- **æ€»ä½“**

  ```mermaid
  flowchart LR
  subgraph åˆå§‹åŒ–
      direction LR
      init_access["access = Semaphore(true)"]
      init_n["n_readers = Mutex(0)"]
      service["service = Semaphore(true)"]
  end
  
  åˆå§‹åŒ– --> ell["â€¦"]
  ```

- **å†™è€…**

  ```mermaid
  flowchart LR
    create --> sleep["sleep(o.start_at)"]
    --> wait_service["wait(service)"]:::sema
    --> wait["wait(access)"]:::sema
    --> signal_service["signal(service)"]:::sema
    --> write:::crit
    --> signal["signal(access)"]:::sema
    
    subgraph service
        wait
        signal_service
    end
    
    subgraph access
        write
        signal
    end
    
    classDef crit fill: red;
    classDef sema fill: orange;
  ```

- **è¯»è€…**

  ```mermaid
  flowchart LR
  create --> sleep["sleep(o.start_at)"]
  --> wait_service["wait(service)"]:::sema
  --> enter
  --> signal_service["signal(service)"]:::sema
  --> write:::crit
  --> exit
  
  subgraph service
      enter
      signal_service
  end
  
  subgraph enter["n_readersçš„äº’æ–¥é”"]
    increase["*n_readers += 1"]
    --> if_first{*n_readers == 1}
    -->|æ˜¯| wait["wait(access)"]:::sema
  end
  
  subgraph exit["n_readersçš„äº’æ–¥é”"]
    decrease["*n_readers -= 1"]
    --> if_last{*n_readers == 0}
    -->|æ˜¯| signal["signal(access)"]:::sema
  end
  
  classDef crit fill: red;
  classDef sema fill: orange;
  ```

### ä¿¡å·é‡`Semaphore`ï¼ˆ`semaphore.rs`ï¼‰

#### èƒŒæ™¯

å› ä¸ºç§ç§åŸå› ï¼ŒRust æ ‡å‡†åº“ä¸­çš„`sync::Semaphore`å·²ç»è¢«æ·˜æ±°äº†ã€‚åœ¨å…±äº«å†…å­˜èŒƒç•´å†…ï¼Œå¯é‡‡ç”¨ä»¥ä¸‹å·¥å…·ã€‚

- **äº’æ–¥é”**`sync::Mutex`ï¼ˆmutual exclusionï¼‰

  ç±»ä¼¼äºåªå–ä¸¤ä¸ªå€¼çš„ä¿¡å·é‡ã€‚

  ```rust
  let data = Arc::new(Mutex::new(0));
  
  thread::spawn(move || {
      // --snip--
      {
          let mut data = data.lock().unwrap();
          *data += 1;
      }
      // --snip--
  });
  ```

  `data.lock()`æ‹¿é”ï¼Œæ‹¿åˆ°å‰ä¸€ç›´é˜»å¡ï¼›å®ƒç»“æŸç”Ÿå‘½æ—¶é‡Šæ”¾é”ã€‚â€”â€”äº’æ–¥é”è§£å†³äº’æ–¥é—®é¢˜ï¼Œå’Œç§ç”¨ä¿¡å·é‡ä¸€æ ·ï¼Œè·å–é”å’Œé‡Šæ”¾é”æ˜¯åœ¨åŒä¸€çº¿ç¨‹ã€‚

  > å¦‚æœæŸæ¡çº¿ç¨‹æ‹¿ç€é”æ—¶ç‚¸äº†ï¼Œå…¶å®ƒçº¿ç¨‹è¯•å›¾æ‹¿é”æ—¶`data.lock()`ä¼šè¿”å›`None`ã€‚

- **æ¡ä»¶å˜é‡**`sync::Condvar`ï¼ˆcondition variableï¼‰

  æ¡ä»¶å˜é‡ä¼ é€’ä¸€ä¸ªé€»è¾‘å˜é‡ï¼Œå¯ä»¥é˜»å¡çº¿ç¨‹ã€‚

  ```rust
  // --snip--
  
  // å­çº¿ç¨‹ä¿®æ”¹åé€šçŸ¥ä¸»çº¿ç¨‹
  thread::spawn(move|| {
      let (lock, cvar) = &*pair2;
      let mut started = lock.lock().unwrap();
      *started = true;
      cvar.notify_one();
  });
  
  // ä¸»çº¿ç¨‹åœ¨æ”¶åˆ°é€šçŸ¥å‰ä¸€ç›´é˜»å¡
  let (lock, cvar) = &*pair;
  let mut started = lock.lock().unwrap();
  while !*started {
      // è¿™é‡Œä¸ä¼šå¿™ç­‰å¾…ï¼Œå› ä¸ºå¤§éƒ¨åˆ†æ—¶é—´é˜»å¡åœ¨ä¸‹é¢è¿™è¡Œ
      started = cvar.wait(started).unwrap();
  }
  ```

#### è®¾è®¡

- ç§ç”¨ä¿¡å·é‡ï¼ˆäº’æ–¥é—®é¢˜ï¼‰ï¼šç›´æ¥ç”¨`Mutex`ã€‚
- å…¬ç”¨ä¿¡å·é‡ï¼ˆåŒæ­¥é—®é¢˜ï¼‰ï¼šä½¿ç”¨è‡ªåˆ¶ä¿¡å·é‡`Semaphore`ã€‚

æœ€åæˆ‘å‘ç°è‡ªåˆ¶ä¿¡å·é‡éå¸¸ç®€å•â€¦â€¦

æˆ‘ä»¬æŠŠ`Mutex`ã€`Condvar`å¯¹~å„¿~å½“ä½œä¿¡å·é‡ã€‚å‰è€…ä¿è¯åŸå­æ€§ï¼Œåè€…é˜»å¡çº¿ç¨‹ã€‚

```rust
use std::sync::{Condvar, Mutex};

type Semaphore = (Mutex<bool>, Condvar);
```

> å› ä¸ºæœ¬å®éªŒç”¨åˆ°ä¿¡å·é‡çš„åœ°æ–¹éƒ½åªæœ‰ä¸€ä¸ªèµ„æºï¼Œæˆ‘å°±ç›´æ¥æŠŠä¿¡å·é‡çš„å€¼è®¾è®¡æˆ`bool`äº†ã€‚

ä¸‹é¢æ¥çœ‹ Pã€V æ“ä½œã€‚

```rust
pub fn wait(semaphore: &Semaphore) {
    let (lock, cvar) = semaphore;
    let mut lock = lock.lock().unwrap();
    while !*lock {
        lock = cvar.wait(lock).unwrap();
    }
    *lock = false;
}

pub fn signal(semaphore: &Semaphore) {
    let (lock, cvar) = semaphore;
    let mut lock = lock.lock().unwrap();
    *lock = true;
    cvar.notify_one();
}
```

- äºŒè€…éƒ½æ˜¯åŸå­æ“ä½œï¼Œä¸Šæ¥éƒ½å…ˆç”¨`lock`é”ä½ã€‚

  > éšå³ç”¨ä¿¡å·é‡çš„å€¼è¦†ç›–åŸæ¥çš„`lock`å˜é‡ã€‚

- `wait`

  - è‹¥æœ‰å‰©ä½™èµ„æºï¼Œ`*lock == true`ï¼Œ`while`è¿›ä¸å»ï¼Œç›´æ¥å æœ‰èµ„æºï¼ˆ`*lock = false`ï¼‰ï¼Œè¿”å›ã€‚
  - å¦åˆ™ï¼Œç”¨`cvar`é˜»å¡å½“å‰çº¿ç¨‹ã€‚ç›´åˆ°æœ‰äººé‡Šæ”¾èµ„æºï¼Œç„¶åé‡è¯•ã€‚

- `signal`

  é‡Šæ”¾èµ„æºï¼ˆ`*lock = true`ï¼‰ï¼Œç”¨`cvar`é€šçŸ¥ä»–äººã€‚

### è®°å½•å‘˜`Reporter`ï¼ˆ`reports.rs`ï¼‰

è®°å½•å‘˜`Reporter`çš„æ ¸å¿ƒåŠŸèƒ½æ˜¯æ‰“å°å¸¦æ—¶é—´çš„è®°å½•ï¼Œè¿™è¦æ±‚æœ‰ä¸ªå˜é‡è®°å½•â€œä¸€åˆ‡å¼€å§‹çš„æ—¶é—´â€ï¼Œå¹¶ä¸”æ¯ä½æ“ä½œå‘˜`Operator`éƒ½èƒ½çŸ¥é“å®ƒçš„å€¼â€”â€”è¿™å·²æ¶‰åŠè¿›ç¨‹é—´çš„**åä½œ**ã€‚è¿™æ—¶è¿˜æ²¡é‚£ä¹ˆå¤æ‚ï¼Œå› ä¸ºâ€œè®¿é—®â€å¹¶ä¸äº’æ–¥ï¼Œç›´æ¥ç”¨æ™®é€šå¸¸é‡å³å¯ã€‚

åæ¥æˆ‘åˆç»™`Reporter`åŠ äº†äº›çŠ¶æ€ï¼ˆæŠŠè®°å½•å­˜å‚¨åˆ°ä¸€ä¸²åˆ—è¡¨é‡Œï¼‰ï¼Œæ¯ä½æ“ä½œå‘˜éƒ½æœ‰å¯èƒ½ä¿®æ”¹â€”â€”è¿™å¼•å‘äº†è´¨å˜ï¼šä¿®æ”¹å¿…é¡»äº’æ–¥ã€‚äºæ˜¯è¦åŠ **äº’æ–¥é”`Mutex`**ï¼Œæ¯ä½æ“ä½œå‘˜è¿˜è¦åœ¨ç™¾å¿™ä¹‹ä¸­ç»´æŠ¤`Reporter`â€¦â€¦è¿™ç§æ–¹å¼æœ€ç»ˆå‘ˆç°ä¸ºå¤æ‚ã€æ··ä¹±ã€æ¶å¿ƒã€‚

åæ¥æˆ‘æ”¹ç”¨æ¶ˆæ¯ä¼ é€’ï¼ˆ`mpsc::channel`ï¼Œmulti-producer, single-consumer channelï¼‰ï¼Œå¥½ä¸€äº›ã€‚

#### åä½œ

è®°å½•å‘˜åœ¨ä¸»çº¿ç¨‹ï¼›æ¯ä½æ“ä½œå‘˜åœ¨ä¸€æ¡çº¿ç¨‹ï¼Œå•å‘å‘é€è®°å½•åˆ°è®°å½•å‘˜ã€‚

```mermaid
flowchart LR
rx -.-> è®°å½•å‘˜

æ“ä½œå‘˜1[æ“ä½œå‘˜] -.-> tx1[tx]
æ“ä½œå‘˜2[æ“ä½œå‘˜] -.-> tx2[tx]
æ“ä½œå‘˜3[æ“ä½œå‘˜] -.-> tx3[tx]

subgraph Sender
    tx1
    tx2
    tx3
end

Sender -->|mpsc::channel| Receiver

subgraph Receiver
    rx
end
```

ä¸»çº¿ç¨‹ä¸­ï¼Œä¸€åˆ‡å¼€å§‹æ—¶è®¾ç½®å¸¸é‡`now`ï¼ˆ`let now = Instant::now()`ï¼‰ï¼Œæ‰€æœ‰çº¿ç¨‹å…±åŒè®¿é—®ï¼ˆå¹¶ä¸ä¿®æ”¹ï¼‰è¿™ä¸€å¸¸é‡ã€‚æ“ä½œå‘˜`Operator`å‘é€æ¶ˆæ¯`ReportMessage`å‰ï¼Œå…ˆè®¡ç®—è·ç¦»`now`çš„æ—¶é—´ï¼ˆ`now.elapsed()`ï¼‰ï¼Œä¸€åŒå‘é€ç»™è®°å½•å‘˜ã€‚

- `run_â—‹â—‹()`ä¸­ï¼Œæ¯ä½æ“ä½œå‘˜`Operator`å‘é€è¿è¡Œè®°å½•ã€‚

  ```rust
  pub fn run_â—‹â—‹(operators: Vec<Operator>, tx: Sender<ReportMessage>) {
      // --snip--
  
      for o in operators {
          // --snip--
          let tx = tx.clone();
  
          thread::spawn(move || {
              tx.send((o.id, Action::Create, now.elapsed())).unwrap();
              // â†‘ å‘è®°å½•å‘˜å‘é€è¿è¡Œè®°å½•ã€‚
  
              // --snip--
          })
      }
  }
  ```

- ä¸»çº¿ç¨‹çš„`main()`ä¸­ï¼Œè®°å½•å‘˜`Reporter`æ¥æ”¶è¿™äº›è®°å½•ã€‚

  ```rust
  fn main() {
      // --snip--
      let args = Args::parse();
      let operators = ready_inputs();
  
      let (tx, rx) = mpsc::channel();
      match args.policy {
          Policy::â—‹â—‹ => run_â—‹â—‹(operators, tx),
          // --snip--
      }
  
      let mut reporter = Reporter::new(config);
      reporter.receive(rx);
      // â†‘ è®°å½•å‘˜æ¥æ”¶è¿è¡Œè®°å½•ã€‚
  }
  ```

#### ç»“æ„å’ŒåŠŸèƒ½

```rust
/// (æ“ä½œå‘˜çš„ id, åŠ¨ä½œ, now.elapsed())
pub type ReportMessage = (u32, Action, Duration);
```

```mermaid
flowchart LR
subgraph enum Action
    Create[åˆ›å»ºçº¿ç¨‹<br>Create]

    subgraph è¯»è€…
        RequestRead[ç”³è¯·è¯»å–<br>RequestRead]
        StartRead[å¼€å§‹è¯»å–<br>StartRead]
        EndRead[ç»“æŸè¯»å–<br>EndRead]
    end
    
    subgraph å†™è€…
        RequestWrite[ç”³è¯·å†™å…¥<br>RequestWrite]
        StartWrite[å¼€å§‹å†™å…¥<br>StartWrite]
        EndWrite[ç»“æŸå†™å…¥<br>EndWrite]
    end
end
```

> `Reporter`å¹¶ä¸æ¶‰åŠ`Operator`çš„å®ç°ç»†èŠ‚ï¼ˆ`OperatorRole`ç­‰ï¼‰ã€‚

```mermaid
classDiagram-v2

class Reporter {
    -gantt: Gantt ç»˜å›¾è®°å½•
    -pending_start_at: HashMap~u32, Duration~
    +æ‰“å°æ ¼å¼ç­‰é…ç½®
    
    +receive(rx: Receiver~ReportMessage~)
    +draw() Vec~String~
}
```

- **`pending_start_at`**

  è®°å½•é‚£äº›å·²å¼€å§‹ã€æœªç»“æŸçš„æ“ä½œå‘˜çš„å¼€å§‹æ—¶é—´ã€‚é”®æ˜¯æ“ä½œå‘˜çš„ idï¼Œå€¼æ˜¯å¼€å§‹æ—¶é—´ã€‚

- **`receive()`**

  ä»`rx`æ¥æ”¶æ‰€æœ‰æ¶ˆæ¯ï¼Œæ¯æ¬¡ç«‹å³æ‰“å°åˆ° stdoutï¼Œé€‚å½“æ—¶ç”¨`gantt`ç»˜å›¾ã€‚

  - æ‰“å°ï¼š`let action_str = match action { â€¦ }`ï¼Œéšä¾¿`println!`å³å¯ã€‚

  - ç»˜å›¾ï¼šæœ‰ Milestoneï¼ˆç¬æ—¶ï¼‰ã€Taskï¼ˆæŒç»­ï¼‰ä¸¤ç§å…ƒç´ ï¼Œåè€…éœ€è¦ç­‰ç»“æŸäº†å†ç»˜å›¾ã€‚

    ```mermaid
    flowchart LR
    match[match action]
    -->|"ğŸš€åˆ›å»º"| milestone["gantt.push_milestone(â€¦)"]
    match -->|"ğŸ””ğŸ‘€ç”³è¯·è¯»å–"| milestone
    match -->|"ğŸ””ğŸ“ç”³è¯·å†™å…¥"| milestone
    
    match -->|"ğŸğŸ‘€å¼€å§‹è¯»å–"| insert[æš‚å­˜å¼€å§‹æ—¶é—´åˆ° pending_start_at]
    match -->|"ğŸğŸ“å¼€å§‹å†™å…¥"| insert
    
    %% å¥½åƒä¸èƒ½å«â€œremoveâ€ï¼Ÿ
    match -->|"ğŸ›‘ğŸ‘€ç»“æŸè¯»å–"| remove_[pending_start_at è·å–å¼€å§‹æ—¶é—´]
    --> task["gantt.push_task(â€¦)"]
    match -->|"ğŸ›‘ğŸ“ç»“æŸå†™å…¥"| remove_
    ```

- **`draw()`**

  è°ƒç”¨`gantt.to_md()`ã€‚

#### Gantt å›¾

ç”Ÿæˆ [mermaid.js çš„ Gantt å›¾](https://mermaid-js.github.io/mermaid/#/gantt)ï¼Œå®ç°ä¸ºå•ç‹¬ä¸€ä¸ªæ¨¡å—ï¼Œä¸æ¶‰åŠä»»ä½•`Reporter`ã€`Operator`ã€‚

å°±æ˜¯å•çº¯å¾€`Vec`æ·»åŠ ä¸œè¥¿ï¼Œæ²¡ä»€ä¹ˆå¯ä»‹ç»çš„â€¦â€¦å”¯ä¸€ç¨å¾®å¤æ‚ç‚¹å„¿çš„æ˜¯`Markdown` traitï¼Œç„¶åé€å±‚å®ç°å®ƒã€‚

```rust
trait Markdown {
    /// Export to mermaid.js markdown, as a list of rows.
    fn to_md(&self) -> Vec<String>;
}
```

1. `pub struct Gantt`
2. `pub struct Section`
3. `enum Record`
   - `struct Milestone`
   - `struct Task`

## å®éªŒç»“æœåŠæ•°æ®åˆ†æ

> è¾“å…¥æ–¹å¼å’Œè¾“å‡ºæ ¼å¼è¯·è§`ReadMe.md`ã€‚

è¿™é‡Œä¸»è¦ä»¥`mixed.in`ä¸ºä¾‹ï¼Œæ­£æ–‡ä¸­æ—¶é—´åªç²¾ç¡®åˆ°ç§’ã€‚

### è¯»è€…ä¼˜å…ˆ

```powershell
> cat .\test_cases\mixed.in | cargo run -- read-preferring --tab 10
 0.000 s |          #1ï¼šğŸš€åˆ›å»ºã€‚
 0.000 s |                                        #4ï¼šğŸš€åˆ›å»ºã€‚
 0.000 s |                              #3ï¼šğŸš€åˆ›å»ºã€‚
 0.000 s |                    #2ï¼šğŸš€åˆ›å»ºã€‚
 0.000 s |                                                  #5ï¼šğŸš€åˆ›å»ºã€‚
 3.013 s |          #1ï¼šğŸ””ğŸ‘€ç”³è¯·è¯»å–ã€‚
 3.013 s |          #1ï¼šğŸğŸ‘€å¼€å§‹è¯»å–ã€‚
 4.008 s |                    #2ï¼šğŸ””ğŸ“ç”³è¯·å†™å…¥ã€‚
 5.004 s |                              #3ï¼šğŸ””ğŸ‘€ç”³è¯·è¯»å–ã€‚
 5.004 s |                              #3ï¼šğŸğŸ‘€å¼€å§‹è¯»å–ã€‚
 5.103 s |                                                  #5ï¼šğŸ””ğŸ“ç”³è¯·å†™å…¥ã€‚
 6.007 s |                                        #4ï¼šğŸ””ğŸ‘€ç”³è¯·è¯»å–ã€‚
 6.007 s |                                        #4ï¼šğŸğŸ‘€å¼€å§‹è¯»å–ã€‚
 7.012 s |                              #3ï¼šğŸ›‘ğŸ‘€ç»“æŸè¯»å–ã€‚
 8.017 s |          #1ï¼šğŸ›‘ğŸ‘€ç»“æŸè¯»å–ã€‚
11.016 s |                                        #4ï¼šğŸ›‘ğŸ‘€ç»“æŸè¯»å–ã€‚
11.016 s |                    #2ï¼šğŸğŸ“å¼€å§‹å†™å…¥ã€‚
16.028 s |                    #2ï¼šğŸ›‘ğŸ“ç»“æŸå†™å…¥ã€‚
16.028 s |                                                  #5ï¼šğŸğŸ“å¼€å§‹å†™å…¥ã€‚
19.033 s |                                                  #5ï¼šğŸ›‘ğŸ“ç»“æŸå†™å…¥ã€‚
```

```mermaid
gantt
dateFormat ss.SSS
axisFormat %S.%L s

section 1
ğŸš€: milestone, 00.000, 0
ğŸ””ğŸ‘€: milestone, 03.013, 0
ğŸ‘€: 03.013, 08.017

section 2
ğŸš€: milestone, 00.000, 0
ğŸ””ğŸ“: milestone, 04.008, 0
ğŸ“: 11.016, 16.028

section 3
ğŸš€: milestone, 00.000, 0
ğŸ””ğŸ‘€: milestone, 05.004, 0
ğŸ‘€: 05.004, 07.012

section 4
ğŸš€: milestone, 00.000, 0
ğŸ””ğŸ‘€: milestone, 06.007, 0
ğŸ‘€: 06.007, 11.016

section 5
ğŸš€: milestone, 00.000, 0
ğŸ””ğŸ“: milestone, 05.103, 0
ğŸ“: 16.028, 19.033
```

é¦–å…ˆç”³è¯·çš„æ˜¯è¯»è€… #1ï¼Œæ­¤åå…¶å®ƒæ“ä½œå‘˜é™†ç»­ç”³è¯·ï¼Œä½†åªæœ‰è¯»è€…çš„ç”³è¯·è¢«æ¥å—ã€‚æ‰€æœ‰è¯»è€…å®Œæˆåï¼Œå†™è€…ä¾æ¬¡æŒ‰ç”³è¯·é¡ºåºæ“ä½œã€‚

- ä¸‰ç§ç­–ç•¥ä¸­ï¼Œè¿™ç§ç­–ç•¥å¹¶è¡Œç¨‹åº¦æœ€é«˜ï¼ˆæœ¬ä¾‹ 6â€“7 s æœ‰ä¸‰ä½è¯»è€…åŒæ—¶æ“ä½œï¼Œ5â€“6 sã€7â€“8 s æœ‰ä¸¤ä½ï¼‰ï¼Œæ€»è¿è¡Œæ—¶é•¿æœ€å°ï¼ˆæœ¬ä¾‹ 19 sï¼‰ã€‚
- ä½†è¯»è€…å›¢ä½“èƒ½â€œæ¥ä¸Šâ€ï¼ˆä¸‹ä¸€è¯»è€…ç”³è¯·æ—©äºä¸Šä¸€è¯»è€…ç»“æŸï¼‰æ—¶ï¼Œå†™è€…è¦ç­‰æ‰€æœ‰è¯»è€…è¯»å®Œï¼Œé€ æˆé¥¥é¥¿â€”â€”æœ¬ä¾‹ä¸­è¯»è€…ä»æœªç­‰å¾…ï¼Œå†™è€…å¹³å‡ç­‰å¾… 9 sã€‚

### å†™è€…ä¼˜å…ˆ

```powershell
> cat .\test_cases\mixed.in | cargo run -- write-preferring --tab 10
 0.000 s |          #1ï¼šğŸš€åˆ›å»ºã€‚
 0.000 s |                              #3ï¼šğŸš€åˆ›å»ºã€‚
 0.000 s |                    #2ï¼šğŸš€åˆ›å»ºã€‚
 0.000 s |                                        #4ï¼šğŸš€åˆ›å»ºã€‚
 0.000 s |                                                  #5ï¼šğŸš€åˆ›å»ºã€‚
 3.009 s |          #1ï¼šğŸ””ğŸ‘€ç”³è¯·è¯»å–ã€‚
 3.009 s |          #1ï¼šğŸğŸ‘€å¼€å§‹è¯»å–ã€‚
 4.010 s |                    #2ï¼šğŸ””ğŸ“ç”³è¯·å†™å…¥ã€‚
 5.003 s |                              #3ï¼šğŸ””ğŸ‘€ç”³è¯·è¯»å–ã€‚
 5.101 s |                                                  #5ï¼šğŸ””ğŸ“ç”³è¯·å†™å…¥ã€‚
 6.012 s |                                        #4ï¼šğŸ””ğŸ‘€ç”³è¯·è¯»å–ã€‚
 8.022 s |          #1ï¼šğŸ›‘ğŸ‘€ç»“æŸè¯»å–ã€‚
 8.022 s |                    #2ï¼šğŸğŸ“å¼€å§‹å†™å…¥ã€‚
13.026 s |                    #2ï¼šğŸ›‘ğŸ“ç»“æŸå†™å…¥ã€‚
13.026 s |                                                  #5ï¼šğŸğŸ“å¼€å§‹å†™å…¥ã€‚
16.031 s |                                                  #5ï¼šğŸ›‘ğŸ“ç»“æŸå†™å…¥ã€‚
16.031 s |                              #3ï¼šğŸğŸ‘€å¼€å§‹è¯»å–ã€‚
16.031 s |                                        #4ï¼šğŸğŸ‘€å¼€å§‹è¯»å–ã€‚
18.041 s |                              #3ï¼šğŸ›‘ğŸ‘€ç»“æŸè¯»å–ã€‚
21.033 s |                                        #4ï¼šğŸ›‘ğŸ‘€ç»“æŸè¯»å–ã€‚
```

```mermaid
gantt
dateFormat ss.SSS
axisFormat %S.%L s

section 1
ğŸš€: milestone, 00.000, 0
ğŸ””ğŸ‘€: milestone, 03.009, 0
ğŸ‘€: 03.009, 08.022

section 2
ğŸš€: milestone, 00.000, 0
ğŸ””ğŸ“: milestone, 04.010, 0
ğŸ“: 08.022, 13.026

section 3
ğŸš€: milestone, 00.000, 0
ğŸ””ğŸ‘€: milestone, 05.003, 0
ğŸ‘€: 16.031, 18.041

section 4
ğŸš€: milestone, 00.000, 0
ğŸ””ğŸ‘€: milestone, 06.012, 0
ğŸ‘€: 16.031, 21.033

section 5
ğŸš€: milestone, 00.000, 0
ğŸ””ğŸ“: milestone, 05.101, 0
ğŸ“: 13.026, 16.031
```

ç¬¬ä¸€ä¸ªè¯»è€… #1 ç»“æŸæ—¶ï¼Œæœ‰å†™è€… #2ã€#5 ç”³è¯·ï¼Œæ­¤åå†™è€…æŒ‰ç”³è¯·é¡ºåºä¾æ¬¡æ“ä½œã€‚å†™è€…å…¨éƒ½ç»“æŸåï¼Œè¯»è€…åŒæ—¶å¼€å§‹æ“ä½œã€‚

- è¿™ç§ç­–ç•¥å¹¶è¡Œç¨‹åº¦ç¨ä½ï¼ˆæœ¬ä¾‹ 16â€“18 s æœ‰ä¸¤ä½è¯»è€…åŒæ—¶æ“ä½œï¼‰ï¼Œæ€»è¿è¡Œæ—¶é•¿è¾ƒå°ï¼ˆæœ¬ä¾‹ 21 sï¼‰ã€‚
- å†™è€…ä¸å†é¥¥é¥¿ã€‚
- ä½†å„ä¸ªå†™è€…èƒ½â€œæ¥ä¸Šâ€æ—¶ï¼Œè¯»è€…è¦ç­‰æ‰€æœ‰å†™è€…è¯»å®Œï¼Œåè€Œé€ æˆäº†è¯»è€…é¥¥é¥¿â€”â€”æœ¬ä¾‹ä¸­è¯»è€…å¹³å‡ç­‰å¾… 7 sï¼Œå†™è€… 6 sã€‚
- è¿™ç§ç­–ç•¥å®ç°èµ·æ¥æœ€å¤æ‚ï¼Œæ–¹æ¡ˆä¸­æœ‰ 2 ä¸ªè®¡æ•°å™¨ã€4 ä¸ªä¿¡å·é‡ã€‚

### å…¬å¹³ç«äº‰

```powershell
> cat .\test_cases\mixed.in | cargo run -- unspecified-priority --tab 10
 0.000 s |          #1ï¼šğŸš€åˆ›å»ºã€‚
 0.000 s |                    #2ï¼šğŸš€åˆ›å»ºã€‚
 0.000 s |                              #3ï¼šğŸš€åˆ›å»ºã€‚
 0.000 s |                                        #4ï¼šğŸš€åˆ›å»ºã€‚
 0.000 s |                                                  #5ï¼šğŸš€åˆ›å»ºã€‚
 3.009 s |          #1ï¼šğŸ””ğŸ‘€ç”³è¯·è¯»å–ã€‚
 3.009 s |          #1ï¼šğŸğŸ‘€å¼€å§‹è¯»å–ã€‚
 4.007 s |                    #2ï¼šğŸ””ğŸ“ç”³è¯·å†™å…¥ã€‚
 5.001 s |                              #3ï¼šğŸ””ğŸ‘€ç”³è¯·è¯»å–ã€‚
 5.104 s |                                                  #5ï¼šğŸ””ğŸ“ç”³è¯·å†™å…¥ã€‚
 6.019 s |                                        #4ï¼šğŸ””ğŸ‘€ç”³è¯·è¯»å–ã€‚
 8.019 s |          #1ï¼šğŸ›‘ğŸ‘€ç»“æŸè¯»å–ã€‚
 8.019 s |                    #2ï¼šğŸğŸ“å¼€å§‹å†™å…¥ã€‚
13.044 s |                    #2ï¼šğŸ›‘ğŸ“ç»“æŸå†™å…¥ã€‚
13.044 s |                              #3ï¼šğŸğŸ‘€å¼€å§‹è¯»å–ã€‚
15.050 s |                              #3ï¼šğŸ›‘ğŸ‘€ç»“æŸè¯»å–ã€‚
15.050 s |                                                  #5ï¼šğŸğŸ“å¼€å§‹å†™å…¥ã€‚
18.054 s |                                                  #5ï¼šğŸ›‘ğŸ“ç»“æŸå†™å…¥ã€‚
18.054 s |                                        #4ï¼šğŸğŸ‘€å¼€å§‹è¯»å–ã€‚
23.077 s |                                        #4ï¼šğŸ›‘ğŸ‘€ç»“æŸè¯»å–ã€‚
```

```mermaid
gantt
dateFormat ss.SSS
axisFormat %S.%L s

section 1
ğŸš€: milestone, 00.000, 0
ğŸ””ğŸ‘€: milestone, 03.009, 0
ğŸ‘€: 03.009, 08.019

section 2
ğŸš€: milestone, 00.000, 0
ğŸ””ğŸ“: milestone, 04.007, 0
ğŸ“: 08.019, 13.044

section 3
ğŸš€: milestone, 00.000, 0
ğŸ””ğŸ‘€: milestone, 05.001, 0
ğŸ‘€: 13.044, 15.050

section 4
ğŸš€: milestone, 00.000, 0
ğŸ””ğŸ‘€: milestone, 06.019, 0
ğŸ‘€: 18.054, 23.077

section 5
ğŸš€: milestone, 00.000, 0
ğŸ””ğŸ“: milestone, 05.104, 0
ğŸ“: 15.050, 18.054
```

æœ‰å†™è€…ç”³è¯·æ—¶æ–°è¯»è€…ç­‰å¾…ï¼Œæœ‰è¯»è€…ç”³è¯·æ—¶æ–°å†™è€…ä¹Ÿç­‰å¾…ã€‚æœ¬ä¾‹ä¸­æ°å¥½è¯»è€…ã€å†™è€…äº¤æ›¿ç”³è¯·ï¼Œå¯¼è‡´ä¹Ÿäº¤æ›¿æ“ä½œã€‚

- è¿™ç§ç­–ç•¥å¹¶è¡Œç¨‹åº¦æœ€ä½ï¼ˆæœ¬ä¾‹å®Œå…¨æ²¡æœ‰å¹¶è¡Œï¼‰ï¼Œæ€»è¿è¡Œæ—¶é•¿æœ€å¤§ï¼ˆæœ¬ä¾‹ 23 sï¼‰ã€‚
- å†™è€…ã€è¯»è€…éƒ½ä¸å†é¥¥é¥¿ã€‚

æ³¨æ„è¿™ç§ç­–ç•¥ä¹Ÿå¯èƒ½å­˜åœ¨å¹¶è¡Œï¼Œè¦æ±‚å†™è€…ç”³è¯·å‰æœ‰å¤šä½è¯»è€…ç”³è¯·ï¼Œå¦‚ä¸‹ä¾‹ã€‚

```mermaid
gantt
dateFormat ss.SSS
axisFormat %S.%L s

section 1
ğŸš€: milestone, 00.000, 0
ğŸ””ğŸ‘€: milestone, 03.005, 0
ğŸ‘€: 03.005, 08.021

section 3
ğŸš€: milestone, 00.000, 0
ğŸ””ğŸ‘€: milestone, 05.011, 0
ğŸ‘€: 05.011, 07.015

section 4
ğŸš€: milestone, 00.000, 0
ğŸ””ğŸ‘€: milestone, 06.009, 0
ğŸ‘€: 06.009, 11.017
```

### `mixed.in`å°ç»“

|   æ•°æ®æˆ–è¯„ä»· |   è¯»è€…ä¼˜å…ˆ    |    å†™è€…ä¼˜å…ˆ     |    å…¬å¹³ç«äº‰    |
| -----------: | :-----------: | :-------------: | :------------: |
|     è¯»è€…ç­‰å¾… | 0 s, 0 s, 0 s | 0 s, 11 s, 10 s | 0 s, 8 s, 12 s |
| è¯»è€…å¹³å‡ç­‰å¾… |      0 s      |       7 s       |      7 s       |
|   è¯»è€…é¥¥é¥¿ï¼Ÿ |       âœ—       |        âœ“        |       âœ—        |
|     å†™è€…ç­‰å¾… |   7 s, 11 s   |    4 s, 8 s     |   4 s, 10 s    |
| å†™è€…å¹³å‡ç­‰å¾… |      9 s      |       6 s       |      7 s       |
|   å†™è€…é¥¥é¥¿ï¼Ÿ |       âœ“       |        âœ—        |       âœ—        |
|       æ€»å¹¶è¡Œ |      4 s      |       2 s       |      0 s       |
|       æ€»è¿è¡Œ |     19 s      |      21 s       |      23 s      |
|     å¹¶è¡Œç¨‹åº¦ |      é«˜       |       ä¸­        |       ä½       |
|       è®¡æ•°å™¨ |     1 ä¸ª      |      2 ä¸ª       |      1 ä¸ª      |
|       ä¿¡å·é‡ |     2 ä¸ª      |      4 ä¸ª       |      3 ä¸ª      |
| å®ç°å¤æ‚ç¨‹åº¦ |      ä½       |       é«˜        |       ä¸­       |

> - æ€»å¹¶è¡Œæ—¶é—´å¯ç´¯è®¡ï¼Œæ¯”å¦‚ä¸‰ä½æ“ä½œå‘˜ä¸€èµ·å¹¶è¡Œ 1 sï¼Œåˆ™æ€»å¹¶è¡Œæ—¶é—´ç®— 3 Ã— 1 s = 3 sã€‚ç›¸åŒæƒ…å†µä¸‹ï¼Œä¸åŒç­–ç•¥çš„æ€»å¹¶è¡Œã€æ€»æ“ä½œçš„æ—¶é—´å’Œæ˜¯å¸¸æ•°ã€‚
> - â€œä¿¡å·é‡â€å«äº’æ–¥é”ã€‚

## æ€»ç»“

- è¦ä»å¤šä¸ªè§†è§’è€ƒè™‘é—®é¢˜ã€‚

  å®ç°æ–¹æ¡ˆæ—¶ï¼Œç¨‹åºè¡Œæ–‡æŒ‰æ¯ä½æ“ä½œå‘˜è‡ªå·±çš„å‰åé€»è¾‘ï¼Œå¯å®é™…è¿˜è¦è€ƒè™‘æ“ä½œå‘˜ä¹‹é—´çš„åŒæ­¥ã€‚å•çœ‹è¯»è€…çš„ç¨‹åºï¼Œæ— æ³•åˆ¤æ–­æ˜¯å¦æ­£ç¡®ï¼Œè¿˜è¦ç»“åˆå†™è€…ç¨‹åºï¼›åä¹‹äº¦ç„¶ã€‚

- ä¸èƒ½ä¸ºçœäº‹å°±ç”³è¯·æœ€é«˜æƒé™ã€‚

  ç¨‹åºå¦‚æœè¦å’Œå…¶å®ƒçº¿ç¨‹çš„ç¨‹åºé…åˆï¼Œè¦æ³¨æ„ç»™å¯¹æ–¹è®©è·¯ã€‚å®ç°å†™è€…ä¼˜å…ˆæ—¶é‚£ä¸ªæ­»é”ï¼Œå°±æ˜¯å› ä¸ºå›¾çœäº‹å…¨å†™é”é‡Œå¤´äº†ã€‚

- éš”ç¦»æ¨¡å—ã€‚

  è®°å½•å‘˜ä¸€å¼€å§‹ç”¨å…±äº«çŠ¶æ€ï¼Œæ¯ä¸ª`run_â—‹â—‹`éƒ½å†™ä¸€éï¼Œæ”¹èµ·æ¥çœŸçš„éå¸¸éº»çƒ¦â€¦â€¦

## é™„å½•

### ç¨‹åºæ¸…å•åŠè¯´æ˜

- `ReadMe.md`ï¼šä½¿ç”¨è¯´æ˜å’Œç¤ºä¾‹ç­‰ã€‚
- `src/`ï¼šæºä»£ç ï¼ˆsourceï¼‰ã€‚
  - `main.rs`ï¼šå¯æ‰§è¡Œæ–‡ä»¶æœ€é¡¶å±‚ã€‚è§£æå‚æ•°ï¼Œè°ƒç”¨åŒ…ã€‚
  - `lib.rs`ï¼šåŒ…çš„æœ€é¡¶å±‚ã€‚å£°æ˜æ¨¡å—ï¼Œå‘å¤–æš´éœ²ä¸œè¥¿ã€‚
  - `operator.rs`ï¼šæ“ä½œå‘˜æ¨¡å—ã€‚
  - `reports.rs`ã€`reports/`ï¼šè®°å½•å‘˜æ¨¡å—
    - `gantt.rs`ï¼šGantt å›¾ç»˜åˆ¶ã€‚
  - `semaphore.rs`ï¼šå…¬ç”¨ä¿¡å·é‡æ¨¡å—ã€‚
  - `solutions.rs`ï¼šå„ç§åŒæ­¥æ–¹æ¡ˆ`run_â—‹â—‹()`ã€‚
- `target/`ï¼šCargo çš„è¾“å‡ºã€‚
  - `release/ex_2.exe`ï¼šå¯æ‰§è¡Œæ–‡ä»¶ã€‚
- `test_cases/`ï¼šæµ‹è¯•ç”¨ä¾‹ï¼Œåªå«è¾“å…¥ã€‚
  - `one_reader.in`
  - `many_readers.in`
  - `one_writer.in`
  - `many_writers.in`
  - `mixed.in`ï¼šé©¬è€å¸ˆæˆ–ç‹è€å¸ˆæä¾›çš„æµ‹è¯•è¾“å…¥ã€‚
  - `gap.in`ï¼šæ“ä½œå‘˜å…¨éƒ½é—´éš”ï¼Œä¸Šä¸€æ“ä½œå‘˜ç»“æŸåä¸‹ä¸€æ“ä½œå‘˜æ‰å¯èƒ½ç”³è¯·ã€‚
